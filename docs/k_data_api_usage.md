# Kçº¿æ•°æ®è·å–APIä½¿ç”¨æ–‡æ¡£

## ğŸ“– æ¦‚è¿°

æœ¬æ¨¡å—æä¾›äº†è·å–è‚¡ç¥¨Kçº¿æ•°æ®çš„APIæ¥å£ï¼Œæ”¯æŒå¤šç§é¢‘ç‡çš„æ•°æ®è·å–ï¼ŒåŒ…æ‹¬æ—¥çº¿ã€åˆ†é’Ÿçº¿ã€å‘¨çº¿ã€æœˆçº¿ç­‰ã€‚åŸºäºbaostockæ•°æ®æºï¼Œä¿æŒåŸå§‹æ•°æ®æ ¼å¼è¾“å‡ºã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
pip install baostock pandas
```

### åŸºæœ¬ä½¿ç”¨

```python
from data_collection.market_data.history_k_data import get_k_data

# è·å–æµ¦å‘é“¶è¡Œæœ€è¿‘20ä¸ªäº¤æ˜“æ—¥çš„æ•°æ®
data = get_k_data('sh.600000', 20)
print(data.head())
```

## ğŸ“‹ APIå‚è€ƒ

### ä¸»è¦å‡½æ•°ï¼šget_k_data()

```python
def get_k_data(stock_code: str, count: int, frequency: str = "d", include_valuation: bool = True) -> Optional[pd.DataFrame]
```

#### å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `stock_code` | str | - | è‚¡ç¥¨ä»£ç ï¼Œæ ¼å¼ï¼š'sh.600000'ï¼ˆä¸Šæµ·ï¼‰æˆ– 'sz.000001'ï¼ˆæ·±åœ³ï¼‰ |
| `count` | int | - | éœ€è¦è·å–çš„Kçº¿æ•°æ®æ¡æ•° |
| `frequency` | str | "d" | æ•°æ®é¢‘ç‡ç±»å‹ï¼Œæ”¯æŒï¼š"d"ã€"w"ã€"m"ã€"5"ã€"15"ã€"30"ã€"60" |
| `include_valuation` | bool | True | æ˜¯å¦åŒ…å«ä¼°å€¼æŒ‡æ ‡ï¼ˆä»…æ—¥çº¿æ”¯æŒï¼‰ |

#### é¢‘ç‡ç±»å‹è¯´æ˜

| é¢‘ç‡ä»£ç  | è¯´æ˜ | æ”¯æŒä¼°å€¼æŒ‡æ ‡ |
|----------|------|--------------|
| "d" | æ—¥Kçº¿ | âœ… |
| "w" | å‘¨Kçº¿ | âŒ |
| "m" | æœˆKçº¿ | âŒ |
| "5" | 5åˆ†é’ŸKçº¿ | âŒ |
| "15" | 15åˆ†é’ŸKçº¿ | âŒ |
| "30" | 30åˆ†é’ŸKçº¿ | âŒ |
| "60" | 60åˆ†é’ŸKçº¿ | âŒ |

#### è¿”å›å€¼

- **æˆåŠŸ**: è¿”å› `pandas.DataFrame`ï¼ŒåŒ…å«Kçº¿æ•°æ®ï¼ˆåŸå§‹å­—ç¬¦ä¸²æ ¼å¼ï¼‰
- **å¤±è´¥**: è¿”å› `None`

### å…¼å®¹å‡½æ•°ï¼šget_daily_k_data()

```python
def get_daily_k_data(stock_code: str, trading_days: int, include_valuation: bool = True) -> Optional[pd.DataFrame]
```

ä¸“é—¨ç”¨äºè·å–æ—¥çº¿æ•°æ®çš„ç®€åŒ–æ¥å£ï¼Œå†…éƒ¨è°ƒç”¨ `get_k_data(stock_code, trading_days, "d", include_valuation)`ã€‚

## ğŸ“Š æ•°æ®å­—æ®µè¯´æ˜

### æ—¥çº¿æ•°æ®å­—æ®µ

| å­—æ®µå | è¯´æ˜ | æ ¼å¼ |
|--------|------|------|
| date | äº¤æ˜“æ‰€è¡Œæƒ…æ—¥æœŸ | YYYY-MM-DD |
| code | è¯åˆ¸ä»£ç  | sh.600000 |
| open | ä»Šå¼€ç›˜ä»·æ ¼ | å­—ç¬¦ä¸²ï¼Œç²¾åº¦4ä½å°æ•° |
| high | æœ€é«˜ä»· | å­—ç¬¦ä¸²ï¼Œç²¾åº¦4ä½å°æ•° |
| low | æœ€ä½ä»· | å­—ç¬¦ä¸²ï¼Œç²¾åº¦4ä½å°æ•° |
| close | ä»Šæ”¶ç›˜ä»· | å­—ç¬¦ä¸²ï¼Œç²¾åº¦4ä½å°æ•° |
| preclose | æ˜¨æ—¥æ”¶ç›˜ä»· | å­—ç¬¦ä¸²ï¼Œç²¾åº¦4ä½å°æ•° |
| volume | æˆäº¤æ•°é‡ | å­—ç¬¦ä¸²ï¼Œå•ä½ï¼šè‚¡ |
| amount | æˆäº¤é‡‘é¢ | å­—ç¬¦ä¸²ï¼Œç²¾åº¦4ä½å°æ•°ï¼Œå•ä½ï¼šå…ƒ |
| adjustflag | å¤æƒçŠ¶æ€ | å­—ç¬¦ä¸² |
| turn | æ¢æ‰‹ç‡ | å­—ç¬¦ä¸²ï¼Œç²¾åº¦6ä½å°æ•°ï¼Œå•ä½ï¼š% |
| tradestatus | äº¤æ˜“çŠ¶æ€ | 1ï¼šæ­£å¸¸äº¤æ˜“ï¼Œ0ï¼šåœç‰Œ |
| pctChg | æ¶¨è·Œå¹… | å­—ç¬¦ä¸²ï¼Œç²¾åº¦6ä½å°æ•°ï¼Œå•ä½ï¼š% |
| isST | æ˜¯å¦ST | 1ï¼šæ˜¯ï¼Œ0ï¼šå¦ |

### ä¼°å€¼æŒ‡æ ‡å­—æ®µï¼ˆä»…æ—¥çº¿ï¼‰

| å­—æ®µå | è¯´æ˜ | æ ¼å¼ |
|--------|------|------|
| peTTM | æ»šåŠ¨å¸‚ç›ˆç‡ | å­—ç¬¦ä¸²ï¼Œç²¾åº¦6ä½å°æ•° |
| psTTM | æ»šåŠ¨å¸‚é”€ç‡ | å­—ç¬¦ä¸²ï¼Œç²¾åº¦6ä½å°æ•° |
| pcfNcfTTM | æ»šåŠ¨å¸‚ç°ç‡ | å­—ç¬¦ä¸²ï¼Œç²¾åº¦6ä½å°æ•° |
| pbMRQ | å¸‚å‡€ç‡ | å­—ç¬¦ä¸²ï¼Œç²¾åº¦6ä½å°æ•° |

### åˆ†é’Ÿçº¿æ•°æ®å­—æ®µ

| å­—æ®µå | è¯´æ˜ | æ ¼å¼ |
|--------|------|------|
| date | æ—¥æœŸ | YYYY-MM-DD |
| time | æ—¶é—´ | HHMMSS000 |
| code | è¯åˆ¸ä»£ç  | sh.600000 |
| open | å¼€ç›˜ä»· | å­—ç¬¦ä¸² |
| high | æœ€é«˜ä»· | å­—ç¬¦ä¸² |
| low | æœ€ä½ä»· | å­—ç¬¦ä¸² |
| close | æ”¶ç›˜ä»· | å­—ç¬¦ä¸² |
| volume | æˆäº¤æ•°é‡ | å­—ç¬¦ä¸² |
| amount | æˆäº¤é‡‘é¢ | å­—ç¬¦ä¸² |
| adjustflag | å¤æƒçŠ¶æ€ | å­—ç¬¦ä¸² |

### å‘¨æœˆçº¿æ•°æ®å­—æ®µ

| å­—æ®µå | è¯´æ˜ | æ ¼å¼ |
|--------|------|------|
| date | æ—¥æœŸ | YYYY-MM-DD |
| code | è¯åˆ¸ä»£ç  | sh.600000 |
| open | å¼€ç›˜ä»· | å­—ç¬¦ä¸² |
| high | æœ€é«˜ä»· | å­—ç¬¦ä¸² |
| low | æœ€ä½ä»· | å­—ç¬¦ä¸² |
| close | æ”¶ç›˜ä»· | å­—ç¬¦ä¸² |
| volume | æˆäº¤æ•°é‡ | å­—ç¬¦ä¸² |
| amount | æˆäº¤é‡‘é¢ | å­—ç¬¦ä¸² |
| adjustflag | å¤æƒçŠ¶æ€ | å­—ç¬¦ä¸² |
| turn | æ¢æ‰‹ç‡ | å­—ç¬¦ä¸² |
| pctChg | æ¶¨è·Œå¹… | å­—ç¬¦ä¸² |

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### 1. è·å–æ—¥çº¿æ•°æ®

```python
from data_collection.market_data.history_k_data import get_k_data

# è·å–æµ¦å‘é“¶è¡Œæœ€è¿‘20ä¸ªäº¤æ˜“æ—¥æ•°æ®ï¼ˆåŒ…å«ä¼°å€¼æŒ‡æ ‡ï¼‰
data = get_k_data('sh.600000', 20, 'd', include_valuation=True)
print(f"è·å–åˆ° {len(data)} æ¡æ—¥çº¿æ•°æ®")
print(f"æ•°æ®å­—æ®µ: {list(data.columns)}")
print(data.head())

# è·å–æ—¥çº¿æ•°æ®ï¼ˆä¸å«ä¼°å€¼æŒ‡æ ‡ï¼‰
data_basic = get_k_data('sh.600000', 20, 'd', include_valuation=False)
```

### 2. è·å–åˆ†é’Ÿçº¿æ•°æ®

```python
# è·å–5åˆ†é’Ÿçº¿æ•°æ®
minute_5_data = get_k_data('sh.600000', 100, '5')
print(f"è·å–åˆ° {len(minute_5_data)} æ¡5åˆ†é’Ÿçº¿æ•°æ®")

# è·å–15åˆ†é’Ÿçº¿æ•°æ®
minute_15_data = get_k_data('sh.600000', 50, '15')

# è·å–30åˆ†é’Ÿçº¿æ•°æ®
minute_30_data = get_k_data('sh.600000', 30, '30')

# è·å–60åˆ†é’Ÿçº¿æ•°æ®
minute_60_data = get_k_data('sh.600000', 20, '60')
```

### 3. è·å–å‘¨çº¿å’Œæœˆçº¿æ•°æ®

```python
# è·å–å‘¨çº¿æ•°æ®
weekly_data = get_k_data('sh.600000', 20, 'w')
print(f"è·å–åˆ° {len(weekly_data)} æ¡å‘¨çº¿æ•°æ®")

# è·å–æœˆçº¿æ•°æ®
monthly_data = get_k_data('sh.600000', 12, 'm')
print(f"è·å–åˆ° {len(monthly_data)} æ¡æœˆçº¿æ•°æ®")
```

### 4. ä½¿ç”¨å…¼å®¹å‡½æ•°

```python
from data_collection.market_data.history_k_data import get_daily_k_data

# ä¸“é—¨è·å–æ—¥çº¿æ•°æ®çš„ç®€åŒ–æ¥å£
daily_data = get_daily_k_data('sh.600000', 20, include_valuation=True)
```

### 5. æ•°æ®å¤„ç†ç¤ºä¾‹

```python
import pandas as pd

# è·å–æ•°æ®
data = get_k_data('sh.600000', 30, 'd')

if data is not None:
    # è½¬æ¢æ•°æ®ç±»å‹ï¼ˆå¦‚éœ€è¦ï¼‰
    data['close'] = pd.to_numeric(data['close'])
    data['volume'] = pd.to_numeric(data['volume'])
    
    # è®¡ç®—ç®€å•ç§»åŠ¨å¹³å‡çº¿
    data['ma5'] = data['close'].rolling(window=5).mean()
    
    # ä¿å­˜åˆ°CSVæ–‡ä»¶
    data.to_csv('stock_data.csv', index=False)
    
    # åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯
    print(f"æœ€é«˜ä»·: {data['high'].astype(float).max()}")
    print(f"æœ€ä½ä»·: {data['low'].astype(float).min()}")
    print(f"å¹³å‡æˆäº¤é‡: {data['volume'].astype(float).mean():.0f}")
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®æ ¼å¼
- æ‰€æœ‰è¿”å›æ•°æ®å‡ä¸º**å­—ç¬¦ä¸²æ ¼å¼**ï¼Œä¿æŒbaostockåŸå§‹è¾“å‡º
- å¦‚éœ€æ•°å€¼è®¡ç®—ï¼Œè¯·ä½¿ç”¨ `pd.to_numeric()` è½¬æ¢

### 2. ä¼°å€¼æŒ‡æ ‡é™åˆ¶
- ä¼°å€¼æŒ‡æ ‡ï¼ˆPEã€PSã€PCFã€PBï¼‰**ä»…æ—¥çº¿æ•°æ®æ”¯æŒ**
- åˆ†é’Ÿçº¿ã€å‘¨çº¿ã€æœˆçº¿ä¼šå¿½ç•¥ `include_valuation` å‚æ•°

### 3. æ—¶é—´èŒƒå›´
- å‡½æ•°ä¼šè‡ªåŠ¨è®¡ç®—åˆé€‚çš„æŸ¥è¯¢æ—¶é—´èŒƒå›´
- æ—¥çº¿ï¼š`count * 2` å¤©
- å‘¨çº¿ï¼š`count * 10` å¤©
- æœˆçº¿ï¼š`count * 40` å¤©
- åˆ†é’Ÿçº¿ï¼š`count // 50 + 10` å¤©

### 4. æ•°æ®æ’åº
- æ‰€æœ‰æ•°æ®æŒ‰æ—¶é—´**é™åºæ’åˆ—**ï¼ˆæœ€æ–°æ•°æ®åœ¨å‰ï¼‰
- åˆ†é’Ÿçº¿æŒ‰ `[date, time]` æ’åº
- å…¶ä»–é¢‘ç‡æŒ‰ `date` æ’åº

### 5. é”™è¯¯å¤„ç†
- ç½‘ç»œé”™è¯¯æˆ–æ•°æ®è·å–å¤±è´¥æ—¶è¿”å› `None`
- å»ºè®®åœ¨ä½¿ç”¨å‰æ£€æŸ¥è¿”å›å€¼æ˜¯å¦ä¸º `None`

## ğŸ”§ å¸¸è§é—®é¢˜

### Q: å¦‚ä½•è·å–æŒ‡æ•°æ•°æ®ï¼Ÿ
A: æŒ‡æ•°ä»£ç æ ¼å¼ä¸è‚¡ç¥¨ç›¸åŒï¼Œå¦‚ä¸Šè¯æŒ‡æ•°ï¼š`sh.000001`ï¼Œæ·±è¯æˆæŒ‡ï¼š`sz.399001`ã€‚æ³¨æ„æŒ‡æ•°æ²¡æœ‰åˆ†é’Ÿçº¿æ•°æ®ã€‚

### Q: å¤æƒç±»å‹å¦‚ä½•é€‰æ‹©ï¼Ÿ
A: ç›®å‰å›ºå®šä½¿ç”¨åå¤æƒï¼ˆadjustflag="3"ï¼‰ï¼Œå¦‚éœ€å…¶ä»–å¤æƒç±»å‹ï¼Œå¯ä¿®æ”¹æºç ä¸­çš„ `adjustflag` å‚æ•°ã€‚

### Q: æ•°æ®æ›´æ–°é¢‘ç‡å¦‚ä½•ï¼Ÿ
A: æ•°æ®æ¥æºäºbaostockï¼Œé€šå¸¸T+1æ›´æ–°ï¼ˆå³å½“æ—¥æ•°æ®æ¬¡æ—¥å¯è·å–ï¼‰ã€‚

### Q: å¦‚ä½•å¤„ç†åœç‰Œæ•°æ®ï¼Ÿ
A: åœç‰ŒæœŸé—´çš„æ•°æ® `tradestatus` å­—æ®µä¸º "0"ï¼Œæ­£å¸¸äº¤æ˜“ä¸º "1"ã€‚

## ğŸ“ æ›´æ–°æ—¥å¿—

- **v1.0**: åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒæ—¥çº¿æ•°æ®è·å–
- **v2.0**: æ‰©å±•æ”¯æŒå¤šé¢‘ç‡Kçº¿æ•°æ®ï¼ˆåˆ†é’Ÿçº¿ã€å‘¨çº¿ã€æœˆçº¿ï¼‰
- **v2.1**: ä¼˜åŒ–æ—¶é—´èŒƒå›´è®¡ç®—å’Œæ•°æ®æ’åºé€»è¾‘

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æäº¤Issueã€‚ 